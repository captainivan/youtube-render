name: Render Remotion Video

on:
  repository_dispatch:
    types: [run_video_render]

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install

      # Debug raw payload
      - name: Debug Payload
        run: |
          echo "RAW PAYLOAD:"
          echo '${{ toJson(github.event.client_payload) }}'

      # Convert props into valid JSON
      - name: Prepare Props JSON
        id: prep
        run: |
          JSON=$(echo '${{ toJson(github.event.client_payload.props) }}')
          echo "props=$JSON" >> $GITHUB_OUTPUT

      # Render video using Remotion
      - name: Render FinalVideo
        run: |
          echo "Rendering with props:"
          echo '${{ steps.prep.outputs.props }}'

          npx remotion render remotion/index.js FinalVideo \
            --props '${{ steps.prep.outputs.props }}' \
            --output out/video.mp4

      # Upload final artifact
      - name: Upload Rendered Video
        uses: actions/upload-artifact@v4
        with:
          name: final-video
          path: out/video.mp4
