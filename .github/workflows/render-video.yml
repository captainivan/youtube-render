name: Render Video + Dynamic Duration + YouTube Upload

on:
  workflow_dispatch: {}
  repository_dispatch:
    types: [run_video_render]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. Install dependencies
      - name: Install dependencies
        run: npm install

      # ----------------------------------------------------
      # 4. Prepare props from client_payload
      # ----------------------------------------------------
      - name: Prepare props
        id: props
        run: |
          JSON=$(printf '%s' \
          "{\"audio\":\"${{ github.event.client_payload.audio }}\",\
          \"basicData\":\"${{ github.event.client_payload.basicData }}\",\
          \"bgImage\":\"${{ github.event.client_payload.bgImage }}\",\
          \"id\":\"${{ github.event.client_payload.id }}\",\
          \"subtitles\":\"${{ github.event.client_payload.subtitles }}\",\
          \"thumbnail\":\"${{ github.event.client_payload.thumbnail }}\"}")

          echo "props=$JSON" >> $GITHUB_OUTPUT

      - name: Show props
        run: |
          echo "Received Props:"
          echo '${{ steps.props.outputs.props }}'

      # ----------------------------------------------------
      # 5. Download basicData.json
      # ----------------------------------------------------
      - name: Download basic data
        run: |
          BASIC_URL=$(echo '${{ steps.props.outputs.props }}' | jq -r '.basicData')
          echo "Downloading: $BASIC_URL"
          curl -L -o basicData.json "$BASIC_URL"
          cat basicData.json

      # ----------------------------------------------------
      # 6. Calculate duration from audio file
      # ----------------------------------------------------
      - name: Calculate audio duration
        run: |
          npm install get-audio-duration

          node << 'EOF'
          import fs from "fs";
          import { getAudioDurationInSeconds } from "get-audio-duration";

          const props = JSON.parse('${{ steps.props.outputs.props }}');
          const audio = props.audio;

          if (!audio) {
            console.error("âŒ audio missing in payload");
            process.exit(1);
          }

          console.log("Fetching audio:", audio);

          const seconds = await getAudioDurationInSeconds(audio);
          const fps = 30;
          const durationInFrames = Math.ceil(seconds * fps);

          console.log("ðŸŽµ Duration seconds:", seconds);
          console.log("ðŸŽž Duration frames:", durationInFrames);

          fs.writeFileSync("duration.json", JSON.stringify({ durationInFrames, fps }));
          EOF

      - name: Show duration.json
        run: cat duration.json

      # ----------------------------------------------------
      # 7. Render Remotion video
      # ----------------------------------------------------
      - name: Render video
        run: |
          PROPS='${{ steps.props.outputs.props }}'
          DURATION=$(cat duration.json)

          FINAL_PROPS=$(jq -n --argjson a "$PROPS" --argjson b "$DURATION" '$a + $b')

          echo "Final props for Remotion:"
          echo "$FINAL_PROPS"

          npx remotion render remotion/index.js FinalVideo \
            --props "$FINAL_PROPS" \
            --output out/video.mp4

      # ----------------------------------------------------
      # 8. Upload rendered video artifact
      # ----------------------------------------------------
      - name: Upload final video
        uses: actions/upload-artifact@v4
        with:
          name: final-video
          path: out/video.mp4

      # ----------------------------------------------------
      # 9. Upload to YouTube
      # ----------------------------------------------------
      - name: Upload to YouTube
        run: |
          npm install googleapis

          node << 'EOF'
          import fs from "fs";
          import { google } from "googleapis";

          const basic = JSON.parse(fs.readFileSync("basicData.json"));

          const title = basic.title || "AI Generated Video";
          const description = basic.description || "Generated by automation.";
          const tags = basic.tags || [];

          console.log("ðŸ“¤ Uploading to YouTube...");
          console.log("Title:", title);

          const oauth2Client = new google.auth.OAuth2(
            process.env.YT_CLIENT_ID,
            process.env.YT_CLIENT_SECRET,
            process.env.YT_REDIRECT_URI
          );

          oauth2Client.setCredentials({
            refresh_token: process.env.YT_REFRESH_TOKEN
          });

          const youtube = google.youtube({ version: "v3", auth: oauth2Client });

          const res = await youtube.videos.insert({
            part: "snippet,status",
            requestBody: {
              snippet: { title, description, tags },
              status: { privacyStatus: "public" }
            },
            media: {
              body: fs.createReadStream("out/video.mp4")
            }
          });

          console.log("ðŸŽ‰ Uploaded! YouTube ID:", res.data.id);
          EOF
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          YT_REDIRECT_URI: ${{ secrets.YT_REDIRECT_URI }}
