name: Render Video + Dynamic Duration + YouTube Upload

on:
  workflow_dispatch: {}
  repository_dispatch:
    types: [run_video_render]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1. Checkout repository
      # -------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Setup Node.js
      # -------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------------------------------
      # 3. Install dependencies
      # -------------------------------------------------
      - name: Install dependencies
        run: npm install

      # -------------------------------------------------
      # 4. Parse props from Next.js repository_dispatch
      # -------------------------------------------------
      - name: Prepare props
        id: props
        run: |
          JSON=$(printf '%s' \
          "{\"audio\":\"${{ github.event.client_payload.audio }}\",\
          \"basicData\":\"${{ github.event.client_payload.basicData }}\",\
          \"bgImage\":\"${{ github.event.client_payload.bgImage }}\",\
          \"id\":\"${{ github.event.client_payload.id }}\",\
          \"subtitles\":\"${{ github.event.client_payload.subtitles }}\",\
          \"thumbnail\":\"${{ github.event.client_payload.thumbnail }}\"}")

          echo "props=$JSON" >> $GITHUB_OUTPUT

      - name: Show props
        run: echo '${{ steps.props.outputs.props }}'

      # -------------------------------------------------
      # 5. Download basicData.json for YouTube metadata
      # -------------------------------------------------
      - name: Download basicData.json
        run: |
          URL=$(echo '${{ steps.props.outputs.props }}' | jq -r '.basicData')
          echo "Downloading basicData.json from: $URL"
          curl -L -o basicData.json "$URL"
          cat basicData.json

      # -------------------------------------------------
      # 6. Calculate audio duration for dynamic frames
      # -------------------------------------------------
      - name: Calculate audio duration
        run: |
          npm install get-audio-duration

          node << 'EOF'
          import fs from "fs";
          import { getAudioDurationInSeconds } from "get-audio-duration";

          const props = JSON.parse('${{ steps.props.outputs.props }}');
          const audioUrl = props.audio;

          if (!audioUrl) {
            console.error("âŒ No audio URL!");
            process.exit(1);
          }

          console.log("Checking audio:", audioUrl);

          const seconds = await getAudioDurationInSeconds(audioUrl);

          const fps = 30;
          const durationInFrames = Math.ceil(seconds * fps);

          console.log("Audio seconds:", seconds);
          console.log("Frames:", durationInFrames);

          fs.writeFileSync("duration.json", JSON.stringify({ durationInFrames, fps }));
          EOF

      - name: Show duration.json
        run: cat duration.json

      # -------------------------------------------------
      # 7. Render the Remotion video
      # -------------------------------------------------
      - name: Render video
        run: |
          PROPS='${{ steps.props.outputs.props }}'
          DURATION=$(cat duration.json)

          FINAL_PROPS=$(jq -n --argjson a "$PROPS" --argjson b "$DURATION" '$a + $b')

          echo "FINAL PROPS:"
          echo "$FINAL_PROPS"

          npx remotion render remotion/index.js FinalVideo \
            --props "$FINAL_PROPS" \
            --output out/video.mp4

      # -------------------------------------------------
      # 8. Upload output video to GitHub artifacts
      # -------------------------------------------------
      - name: Upload rendered video
        uses: actions/upload-artifact@v4
        with:
          name: final-video
          path: out/video.mp4

      # -------------------------------------------------
      # 9. Upload to YouTube (with SAFE tag cleaning)
      # -------------------------------------------------
      - name: Upload to YouTube
        run: |
          npm install googleapis

          node << 'EOF'
          import fs from "fs";
          import { google } from "googleapis";

          const basic = JSON.parse(fs.readFileSync("basicData.json"));

          const title = basic.title || "AI Generated Video";
          const description = basic.description || "Generated automatically.";

          let tags = Array.isArray(basic.tags) ? basic.tags : [];

          // Clean tags to prevent INVALID TAGS error
          tags = tags
            .map(t => String(t).trim())
            .filter(t => t.length > 0)
            .filter(t => !t.includes(","))
            .filter(t => /^[a-zA-Z0-9 _-]+$/.test(t))
            .slice(0, 20);

          console.log("Sanitized Tags:", tags);

          const oauth = new google.auth.OAuth2(
            process.env.YT_CLIENT_ID,
            process.env.YT_CLIENT_SECRET,
            process.env.YT_REDIRECT_URI
          );

          oauth.setCredentials({
            refresh_token: process.env.YT_REFRESH_TOKEN
          });

          const youtube = google.youtube({
            version: "v3",
            auth: oauth
          });

          async function upload() {
            const res = await youtube.videos.insert({
              part: "snippet,status",
              requestBody: {
                snippet: { title, description, tags },
                status: { privacyStatus: "public" }
              },
              media: {
                body: fs.createReadStream("out/video.mp4")
              }
            });

            console.log("ðŸŽ‰ Uploaded to YouTube! Video ID:", res.data.id);
          }

          upload();
          EOF
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          YT_REDIRECT_URI: ${{ secrets.YT_REDIRECT_URI }}
